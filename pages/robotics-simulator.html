<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Morten Lysgaard">
  <meta name="author" content="Morten Lysgaard">
  <title>Robotics Simulator</title>
  <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
              showMathMenu: false,
              jax: ["input/TeX","output/CommonHTML"],
              extensions: ["tex2jax.js"],
              messageStyle: "none",
                tex2jax: {
                  processEscapes: true,
                  ignoreClass: "tex2jax_ignore",
                  processClass: "math"
                },
              TeX: { 
                extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js","autobold.js"],
                Macros: { 
                    R: '{\\mathbb{R}}', 
                    N: '{\\mathbb{N}}', 
                    Z: '{\\mathbb{Z}}', 
                    C: '{\\mathbb{C}}', 
                    F: '{\\mathbb{F}}', 
                    argmin: '{\\mathop{\\operatorname*{arg\\,min}}}',
                    argmax: '{\\mathop{\\operatorname*{arg\\,max}}}',
                    mex: '{\\mathop{\\operatorname{mex}}}', 
                    lcm: '{\\mathop{\\operatorname{lcm}}}',
                    bigtriangleright: '{\\mathop{\\Large \\triangleright}}',
                    bigtriangleleft: '{\\mathop{\\Large \\triangleleft}}',
                    set: ['\\left\\{ #1 \\right\\}',1],
                    floor: ['\\left\\lfloor #1 \\right\\rfloor',1],
                    ceil:  ['\\left\\lceil #1 \\right\\rceil',1],
                    abs:  ['\\left| #1 \\right|',1]
                 } 
                },
                "HTML-CSS": { fonts: ["STIX"] }
            });
        </script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="stylesheet" href="/css/default.css" />

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-24607697-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-24607697-1');
  </script>

</head>

<body class="tex2jax_ignore">
  <header class="hide-on-print">
    <div id="blog-title">
      <a href="/">Morten Lysgaard</a>
    </div>
    <nav>
      <ul style="display: inline-block;">
        <li><a href="/">Home</a></li>
        <!--li><a href="/pages/cv.html">CV</a></li-->
        <li><a href="/pages/trajectory-optimization-toolbox.html">Trajectory Optimization Toolbox</a></li>
        <li><a href="/pages/robotics-simulator.html">Robotics Simulator</a></li>
        <li><a href="/posts.html">Posts</a></li>
        <!--li><a href="/archive.html">Archive</a></li-->
      </ul>
    </nav>
  </header>
  <article>
    <h1 id="article-title">Robotics Simulator</h1>
    <h1 id="introduction"><span class="header-section-number">1</span> Introduction</h1>
<p>One of the main challenges with developing drones, is the amount of physical testing required. Back in 2015-2016 when we were in the most intense period of development of the Staaker drone, I realized that if we could make our testing and verification more effective, we could improve our development speed drastically. This spawned the simulator project.</p>
<h1 id="demo-videos"><span class="header-section-number">2</span> Demo videos</h1>
<h2 id="ci"><span class="header-section-number">2.1</span> Continous integration</h2>
<p>This video demonstrates some of the automatic tests that run in our CI solution. The tests are scripted in a DSL, embedded in C++, letting us express arbitrary missions, assertions that lead to test failure, and arbitrary events that happens to the simulated world during the mission.</p>
<video class="video-width" autoplay="true" muted="true" loop="true">
<source src="/files/videos/robot-simulator/robot-simulator-automatic-test.webm" type="video/webm">
<source src="/files/videos/robot-simulator/robot-simulator-automatic-test.mp4" type="video/mp4">
</video>
<h2 id="vis"><span class="header-section-number">2.2</span> Visualizations</h2>
<h3 id="smooth-terrain"><span class="header-section-number">2.2.1</span> Smooth terrain</h3>
<p>This smooth terrain is used to simulate visual navigation in 3D environments. It is generated by first creating smooth <a href="https://en.wikipedia.org/wiki/Perlin_noise">3D Perlin noise</a>, then interpreting this noise as a <a href="https://en.wikipedia.org/wiki/Signed_distance_function">signed distance field</a>. A marching cubes algorithm is run on this signed distance field to generate a meshing of a contour in the field. Correct normals and tangents are computed, as well as a automatically generated UV-map using the <a href="https://libigl.github.io/tutorial/#as-rigid-as-possible">ARAP</a> algorithm.</p>
<video class="video-width" autoplay="true" muted="true" loop="true">
<source src="/files/videos/robot-simulator/robot-simulator-smooth-terrain.webm" type="video/webm">
<source src="/files/videos/robot-simulator/robot-simulator-smooth-terrain.mp4" type="video/mp4">
</video>
<h3 id="voxel-grid"><span class="header-section-number">2.2.2</span> Voxel grid</h3>
<p>Voxel grid datastructure, with accompanying GPU-visualization. Uses a dynamic index buffer, together with a static vertex buffer, which saves quite some CPU-GPU memory traffic. Supports raycasting for dynamically building probabilistic occupancy maps, much like the technique used in <a href="https://google-cartographer.readthedocs.io/en/latest/">Google Cartographer</a></p>
<video class="video-width" autoplay="true" muted="true" loop="true">
<source src="/files/videos/robot-simulator/robot-simulator-voxel-grid.webm" type="video/webm">
<source src="/files/videos/robot-simulator/robot-simulator-voxel-grid.mp4" type="video/mp4">
</video>
<h2 id="sensors"><span class="header-section-number">2.3</span> Simulated sensors</h2>
<p>This video demonstrates what happens with the drone state estimates and control system when unrealistically large noise is injected into the GPS position and velocity estimates.</p>
<video class="video-width" autoplay="true" muted="true" loop="true">
<source src="/files/videos/robot-simulator/robot-simulator-gps-noise.webm" type="video/webm">
<source src="/files/videos/robot-simulator/robot-simulator-gps-noise.mp4" type="video/mp4">
</video>
<h1 id="some-features-i-implemented"><span class="header-section-number">3</span> Some features I implemented</h1>
<ul>
<li><strong>Architecture:</strong>
<ul>
<li>Focus separation between rendering and simulation/physics.</li>
<li>Rolled our own C++ entity component system system.</li>
</ul></li>
<li><strong>Rendering engine:</strong> Filament physically based renderer, after a survey spanning everything from Unreal to Ogre 3D.</li>
<li><strong>Physics motor:</strong> developed from scratch in C++ using Eigen.
<ul>
<li>Very accurate integration of multirotor ODEs using Runge-Kutta methods for linear parts and quaternion exponential maps for orientation.</li>
<li>As a proof of concept I integrated DART physics motor, but as we are flying, we did not have that much use for its advanced support of contacts.</li>
<li>Ended up just rolling my own rudamentary collision simulation.</li>
<li>Would integrate DART or similar if advanced collision handling was needed.</li>
</ul></li>
<li><strong><a href="#ci">Continuous integration:</a></strong>
<ul>
<li>Developed a domain specific language embedded in C++ for specifying flight scenarios.</li>
<li>Very flexible language, executed by the simulator when run in test mode, able to express:
<ul>
<li>What to do, eg. a mission and its sub-steps</li>
<li>Abnormal behaviour, like suddenly removing a motor mid flight or receiving garbled gyro-data</li>
<li>What to check, arbitrary assertions that can be run at any time during the simulation, and that has ability to inspect the whole simulator state.</li>
</ul></li>
<li>This language was used to create a large test suite, that was run on each commit software in the loop.</li>
<li>This made it possible to develop autopilot code changes with great confidence, and accelerated our development process enormously</li>
</ul></li>
<li><strong><a href="#vis">Visualizations:</a></strong>
<ul>
<li>Colored point clouds</li>
<li><a href="#voxel-grid">Voxelgrids</a></li>
<li><a href="#smooth-terrain">Marching cubes on smooth signed distance functions for arbitrary 3D terrain generation</a></li>
<li>3D cubic splines</li>
</ul></li>
<li><strong><a href="#sensors">Simulated sensors:</a></strong>
<ul>
<li>Gyroscope, accelerometer, barometer and magnetometer with realistic noise characteristics</li>
<li>GPS with a complex noise model simulating not just standard Gaussian noise</li>
<li>RGB cameras, available for visual navigation algorithms</li>
<li>Depth cameras, available for visual navigation algorithms</li>
<li>LIDAR, rudamentary simulation, available for navigation algorithms</li>
</ul></li>
</ul>

  </article>
  <footer class="hide-on-print">Â© 2011 -
    <script>document.write(new Date().getFullYear())</script> Morten Lysgaard. Licensed under GPL-v3 or later unless
    otherwise specified.
  </footer>

</body>

</html>

</html>